@Library('vl-jenkins')_

import no.nav.jenkins.*

node('DOCKER3') {
  Date date= new Date()
	
	def revision = "1.0.0"
	def changelist
        def tagName
    
    maven = new maven()
    stage('Checkout Tags') { // checkout only tags.
        checkout scm
	GIT_COMMIT_HASH = sh (script: "git log -n 1 --pretty=format:'%h'", returnStdout: true)
	changelist = "_" + date.format("YYYYMMDDHHmmss") + "_" + GIT_COMMIT_HASH
	tagName=revision + changelist
	
        echo "Tag to be deployed $tagName"
	}
   
	stage('Build') {
       configFileProvider(
           [configFile(fileId: 'navMavenSettingsUtenProxy', variable: 'MAVEN_SETTINGS')]) {
				
				environment = new environment()
                if(maven.javaVersion() != null) {
                    environment.overrideJDK(maven.javaVersion())
                }
				
                sh "mvn -U -B -s $MAVEN_SETTINGS -Dfile.encoding=UTF-8 -DdeployAtEnd=true -Dsha1= -Dchangelist= -Drevision=$tagName clean deploy"
				
           }   
                
    }
}
